<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buscar Mensajes en Chat</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script> 
</head>
<body>

    <h1>ğŸ” Buscar Mensajes en Chat</h1>
    
    <div style="text-align: center; margin: 20px 0;">
        <a href="index.html" style="display: inline-block; padding: 10px 20px; background: #007bff; color: white; text-decoration: none; border-radius: 5px; margin: 0 10px;">ğŸ” BÃºsqueda</a>
        <a href="estadisticas.html" style="display: inline-block; padding: 10px 20px; background: #6c757d; color: white; text-decoration: none; border-radius: 5px; margin: 0 10px;">ğŸ“Š EstadÃ­sticas</a>
    </div>
    
    <div class="search-container">
        <div class="filter-row">
            <select id="project-filter" style="padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; margin-bottom: 10px; width: 300px;">
                <option value="">ğŸ—‚ï¸ Todos los proyectos</option>
            </select>
        </div>
        
        <div class="search-type-selector" style="margin-bottom: 15px; text-align: center;">
            <label style="margin-right: 20px;">
                <input type="radio" name="search-type" value="conversations" checked> 
                ğŸ’¬ Buscar en tÃ­tulos de conversaciones
            </label>
            <label>
                <input type="radio" name="search-type" value="messages"> 
                ğŸ“ Buscar en contenido de mensajes
            </label>
        </div>
        
        <div class="search-row">
            <input type="text" id="query" placeholder="Escribe tu bÃºsqueda aquÃ­...">
            <button onclick="buscarMensajes()">ğŸ” Buscar</button>
            <button onclick="mostrarTodo()">ğŸ“‹ Mostrar Todo</button>
        </div>
    </div>
    
    <div id="loading" style="display:none;">ğŸ”„ Cargando resultados...</div>

    <table>
        <thead>
            <tr>
                <th>Proyecto</th>
                <th>ConversaciÃ³n</th>
                <th>Fecha</th>
                <th>Rol</th>
                <th>Mensaje</th>
            </tr>
        </thead>
        <tbody id="resultados"></tbody>
    </table>

    <!-- Modal para ver imÃ¡genes en grande -->
    <div id="modal" class="modal">
        <span class="close" onclick="cerrarModal()">&times;</span>
        <img id="modal-img" class="modal-content">
    </div>

    <script>
        // Cargar proyectos al iniciar
        async function cargarProyectos() {
            try {
                const response = await fetch('../api/api_get_projects.php');
                const data = await response.json();
                
                const select = document.getElementById('project-filter');
                
                data.projects.forEach(project => {
                    const option = document.createElement('option');
                    option.value = project.id;
                    option.textContent = `${project.name} (${project.actual_conversations})`;
                    select.appendChild(option);
                });
                
            } catch (error) {
                console.error('Error cargando proyectos:', error);
            }
        }

        function buscarMensajes() {
            const query = document.getElementById("query").value;
            const projectId = document.getElementById("project-filter").value;
            const searchType = document.querySelector('input[name="search-type"]:checked').value;
            
            document.getElementById("loading").style.display = "block";
            document.getElementById("resultados").innerHTML = "";
            
            // Construir URL con parÃ¡metros
            let url = '../api/buscar_chat.php';
            let params = new URLSearchParams();
            
            if (query.trim()) {
                params.append('query', query);
                params.append('search_type', searchType);
            }
            if (projectId) {
                params.append('project_id', projectId);
            }
            
            if (params.toString()) {
                url += '?' + params.toString();
            }
            
            fetch(url)
                .then(response => {
                    document.getElementById("loading").style.display = "none";
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log("Data received:", data);
                    
                    // Manejar la nueva estructura de respuesta
                    const results = data.results || data;
                    
                    if (!Array.isArray(results)) {
                        console.error("Respuesta inesperada del servidor:", data);
                        document.getElementById("resultados").innerHTML = `<tr><td colspan="5">Error al procesar la respuesta</td></tr>`;
                        return;
                    }

                    const resultados = document.getElementById("resultados");
                    resultados.innerHTML = "";

                    if (results.length === 0) {
                        const searchTerm = query || 'el proyecto seleccionado';
                        resultados.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:20px;">No se encontraron resultados para "${searchTerm}"</td></tr>`;
                        return;
                    }

                    results.forEach(mensaje => {
                        const fila = document.createElement("tr");
                        fila.classList.add(mensaje.message_role === "user" ? "user" : "assistant");

                        const celdaProyecto = document.createElement("td");
                        celdaProyecto.textContent = mensaje.project_name || 'Sin proyecto';
                        celdaProyecto.style.fontWeight = '500';
                        celdaProyecto.style.color = '#007bff';

                        const celdaTitulo = document.createElement("td");
                        celdaTitulo.textContent = mensaje.title;
                        
                        const celdaFecha = document.createElement("td");
                        const fecha = new Date(mensaje.create_time);
                        celdaFecha.textContent = fecha.toLocaleDateString() + ", " + fecha.toLocaleTimeString();

                        const celdaRol = document.createElement("td");
                        celdaRol.textContent = mensaje.message_role;

                        const celdaMensaje = document.createElement("td");
                        celdaMensaje.innerHTML = procesarMensaje(mensaje.message_content);

                        fila.appendChild(celdaProyecto);
                        fila.appendChild(celdaTitulo);
                        fila.appendChild(celdaFecha);
                        fila.appendChild(celdaRol);
                        fila.appendChild(celdaMensaje);
                        resultados.appendChild(fila);
                    });
                })
                .catch(error => {
                    document.getElementById("loading").style.display = "none";
                    console.error("Error:", error);
                    document.getElementById("resultados").innerHTML = `<tr><td colspan="5" style="text-align:center; padding:20px; color:red;">âŒ Error al buscar mensajes: ${error.message}</td></tr>`;
                });
        }

        function mostrarTodo() {
            document.getElementById("query").value = "";
            document.getElementById("project-filter").value = "";
            document.getElementById("loading").style.display = "block";
            document.getElementById("resultados").innerHTML = "";
            
            // Usar bÃºsqueda de conversaciones en lugar de mensajes para "Mostrar Todo"
            fetch(`../api/buscar_chat.php?query=&search_type=conversations`)
                .then(response => {
                    document.getElementById("loading").style.display = "none";
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log("Showing all conversations:", data);
                    
                    // Verificar si la respuesta tiene la estructura correcta
                    if (!data.success || !Array.isArray(data.results)) {
                        console.error("Respuesta inesperada del servidor:", data);
                        document.getElementById("resultados").innerHTML = `<tr><td colspan="5">Error al procesar la respuesta</td></tr>`;
                        return;
                    }

                    const resultados = document.getElementById("resultados");
                    resultados.innerHTML = "";

                    if (data.results.length === 0) {
                        resultados.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:20px;">No hay conversaciones en la base de datos</td></tr>`;
                        return;
                    }

                    data.results.forEach(mensaje => {
                        const fila = document.createElement("tr");
                        fila.classList.add("conversation");

                        const celdaProyecto = document.createElement("td");
                        celdaProyecto.textContent = mensaje.project_name || 'Sin proyecto';
                        celdaProyecto.style.fontWeight = '500';
                        celdaProyecto.style.color = '#007bff';

                        const celdaTitulo = document.createElement("td");
                        celdaTitulo.textContent = mensaje.title || 'Sin tÃ­tulo';
                        
                        const celdaFecha = document.createElement("td");
                        const fecha = new Date(mensaje.create_time);
                        celdaFecha.textContent = fecha.toLocaleDateString() + ", " + fecha.toLocaleTimeString();

                        const celdaRol = document.createElement("td");
                        celdaRol.textContent = mensaje.message_role;

                        const celdaMensaje = document.createElement("td");
                        celdaMensaje.innerHTML = procesarMensaje(mensaje.message_content);

                        fila.appendChild(celdaProyecto);
                        fila.appendChild(celdaTitulo);
                        fila.appendChild(celdaFecha);
                        fila.appendChild(celdaRol);
                        fila.appendChild(celdaMensaje);
                        resultados.appendChild(fila);
                    });
                })
                .catch(error => {
                    document.getElementById("loading").style.display = "none";
                    console.error("Error:", error);
                    document.getElementById("resultados").innerHTML = `<tr><td colspan="5" style="text-align:center; padding:20px; color:red;">âŒ Error al cargar mensajes: ${error.message}</td></tr>`;
                });
        }

        function procesarMensaje(contenido) {
            if (!contenido) return "";
            
            try {
                const parts = JSON.parse(contenido);
                let html = "";
                
                if (Array.isArray(parts)) {
                    parts.forEach(part => {
                        if (typeof part === 'string') {
                            html += marked.parse(part);
                        }
                    });
                } else {
                    html = marked.parse(contenido);
                }
                
                return html;
            } catch (e) {
                return marked.parse(contenido);
            }
        }

        function procesarImagen(imagenSrc) {
            if (!imagenSrc) return "";
            
            const imagenHTML = `<img src="${imagenSrc}" alt="Imagen" style="max-width: 200px; cursor: pointer;" onclick="abrirModal('${imagenSrc}')">`;
            
            return imagenHTML || `<img src="uploads/imagen_no_disponible.png" alt="Imagen no encontrada">`;
        }

        function abrirModal(imagenSrc) {
            const modal = document.getElementById("modal");
            const modalImg = document.getElementById("modal-img");
            modal.style.display = "block";
            modalImg.src = imagenSrc;
        }

        function cerrarModal() {
            document.getElementById("modal").style.display = "none";
        }

        // Cambiar placeholder segÃºn el tipo de bÃºsqueda
        function updatePlaceholder() {
            const searchType = document.querySelector('input[name="search-type"]:checked').value;
            const queryInput = document.getElementById("query");
            
            if (searchType === 'conversations') {
                queryInput.placeholder = "Buscar en tÃ­tulos de conversaciones...";
            } else {
                queryInput.placeholder = "Buscar en contenido de mensajes...";
            }
        }

        // Permitir bÃºsqueda con Enter
        document.getElementById("query").addEventListener("keypress", function(event) {
            if (event.key === "Enter") {
                buscarMensajes();
            }
        });

        // Cargar proyectos y algunos mensajes al inicio
        document.addEventListener("DOMContentLoaded", function() {
            cargarProyectos();
            mostrarTodo();
            updatePlaceholder();
            
            // Agregar listeners a los radio buttons
            document.querySelectorAll('input[name="search-type"]').forEach(radio => {
                radio.addEventListener('change', updatePlaceholder);
            });
        });
    </script>

</body>
</html>