<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatBETO - Buscar Mensajes en Chat</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .filters {
            display: grid;
            grid-template-columns: 1fr 1.5fr 1.5fr 1fr 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 6px;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
        }
        
        .filter-group label {
            font-weight: 600;
            margin-bottom: 5px;
            color: #333;
        }
        
        .filter-group input, .filter-group select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .search-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 22px;
        }
        
        .search-btn:hover {
            background: #0056b3;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
        }
        
        .stat-card h3 {
            margin: 0;
            font-size: 24px;
        }
        
        .stat-card p {
            margin: 5px 0 0 0;
            opacity: 0.9;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
        }
        
        .messages-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .messages-table th,
        .messages-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .messages-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #333;
        }
        
        .messages-table tr:hover {
            background-color: #f8f9fa;
        }
        
        .role-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .role-user {
            background: #e3f2fd;
            color: #1976d2;
        }
        
        .role-assistant {
            background: #e8f5e8;
            color: #388e3c;
        }
        
        .role-system {
            background: #fff3e0;
            color: #f57c00;
        }
        
        .role-tool {
            background: #f3e5f5;
            color: #7b1fa2;
        }
        
        .message-content {
            max-width: 400px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .message-content:hover {
            white-space: normal;
            word-break: break-word;
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 20px 0;
            gap: 10px;
        }
        
        .pagination button {
            padding: 8px 16px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .pagination button:hover:not(:disabled) {
            background: #f8f9fa;
        }
        
        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .pagination .current-page {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }
        
        .project-selector {
            padding: 4px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            font-size: 12px;
            min-width: 100px;
        }
        
        .project-selector:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }
        
        .update-success {
            background: #d4edda;
            color: #155724;
            padding: 8px 12px;
            border-radius: 4px;
            margin: 10px 0;
            border: 1px solid #c3e6cb;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç Buscar Mensajes en Chat</h1>
            <p>Reporte de mensajes y conversaciones - ChatBETO</p>
        </div>

        <div class="filters">
            <div class="filter-group">
                <label for="projectSelect">Proyecto:</label>
                <select id="projectSelect">
                    <option value="1">Proyecto 1</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label for="conversationSearch">Filtrar por conversaci√≥n:</label>
                <input type="text" id="conversationSearch" placeholder="Buscar por t√≠tulo de conversaci√≥n...">
            </div>
            
            <div class="filter-group">
                <label for="searchInput">Buscar en contenido:</label>
                <input type="text" id="searchInput" placeholder="Buscar texto en mensajes...">
            </div>
            
            <div class="filter-group">
                <label for="roleFilter">Filtrar por rol:</label>
                <select id="roleFilter">
                    <option value="">Todos los roles</option>
                    <option value="user">Usuario</option>
                    <option value="assistant">Asistente</option>
                    <option value="system">Sistema</option>
                    <option value="tool">Herramienta</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label for="currentProjectFilter">Filtrar por proyecto:</label>
                <select id="currentProjectFilter">
                    <option value="">Todos los proyectos</option>
                    <option value="1">MercadoSur</option>
                    <option value="64">ChatGPT</option>
                    <option value="67">Proyecto Principal</option>
                </select>
            </div>
            
            <div class="filter-group">
                <button class="search-btn" onclick="searchMessages()">üîç Buscar</button>
            </div>
        </div>

        <div class="stats" id="statsContainer">
            <!-- Las estad√≠sticas se cargan aqu√≠ -->
        </div>

        <div id="loadingIndicator" class="loading" style="display: none;">
            ‚è≥ Cargando mensajes...
        </div>

        <div id="errorContainer"></div>

        <div id="resultsContainer">
            <!-- Los resultados se cargan aqu√≠ -->
        </div>

        <div class="pagination" id="paginationContainer" style="display: none;">
            <!-- La paginaci√≥n se carga aqu√≠ -->
        </div>
    </div>

    <script>
        // Configuraci√≥n de la API para servidor PHP integrado
        const API_BASE = 'http://localhost:8002/api';
        let currentPage = 0;
        const messagesPerPage = 20;
        let totalMessages = 0;

        // Cargar datos iniciales al cargar la p√°gina
        window.onload = function() {
            loadProjects();
            loadStats();
            searchMessages();
        };

        // Cargar lista de proyectos
        async function loadProjects() {
            try {
                const response = await fetch(`${API_BASE}/get_projects_list.php`);
                const data = await response.json();
                
                if (data.success) {
                    const select = document.getElementById('projectSelect');
                    select.innerHTML = '';
                    
                    data.data.forEach(project => {
                        const option = document.createElement('option');
                        option.value = project.id;
                        option.textContent = `${project.name} (${project.message_count} mensajes)`;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error cargando proyectos:', error);
            }
        }

        async function loadStats() {
            const projectId = document.getElementById('currentProjectFilter').value;
            
            try {
                // Si no hay proyecto seleccionado, usar endpoint sin filtro de proyecto
                const endpoint = projectId 
                    ? `${API_BASE}/get_project_stats.php?project_id=${projectId}`
                    : `${API_BASE}/get_project_stats.php`; // Stats de todos los proyectos
                    
                const response = await fetch(endpoint);
                const data = await response.json();
                
                if (data.success) {
                    const stats = data.stats;
                    document.getElementById('statsContainer').innerHTML = `
                        <div class="stat-card">
                            <h3>${stats.total_conversations}</h3>
                            <p>Conversaciones</p>
                        </div>
                        <div class="stat-card">
                            <h3>${stats.total_messages}</h3>
                            <p>Mensajes Totales</p>
                        </div>
                        <div class="stat-card">
                            <h3>${stats.user_messages}</h3>
                            <p>Mensajes Usuario</p>
                        </div>
                        <div class="stat-card">
                            <h3>${stats.assistant_messages}</h3>
                            <p>Mensajes Asistente</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error cargando estad√≠sticas:', error);
            }
        }

        // Buscar mensajes con filtros
        async function searchMessages() {
            const currentProjectId = document.getElementById('currentProjectFilter').value;
            const search = document.getElementById('searchInput').value;
            const role = document.getElementById('roleFilter').value;
            const conversationSearch = document.getElementById('conversationSearch').value;
            
            const loading = document.getElementById('loadingIndicator');
            const errorContainer = document.getElementById('errorContainer');
            const resultsContainer = document.getElementById('resultsContainer');
            
            loading.style.display = 'block';
            errorContainer.innerHTML = '';
            resultsContainer.innerHTML = '';
            
            try {
                const queryParams = new URLSearchParams({
                    limit: messagesPerPage,
                    offset: currentPage * messagesPerPage,
                    order_by: 'created_at',
                    order_direction: 'DESC'
                });
                
                // Solo agregar project_id si hay un proyecto espec√≠fico seleccionado
                if (currentProjectId) {
                    queryParams.append('project_id', currentProjectId);
                }
                
                if (search) queryParams.append('search', search);
                if (role) queryParams.append('role', role);
                if (conversationSearch) queryParams.append('conversation_search', conversationSearch);
                
                const response = await fetch(`${API_BASE}/messages_simple_working.php?${queryParams}`);
                const data = await response.json();
                
                loading.style.display = 'none';
                
                if (data.success) {
                    displayMessages(data.data);
                    totalMessages = data.totalMessages || data.count || 0; 
                    updatePagination();
                } else {
                    showError(`Error: ${data.error}`);
                }
                
            } catch (error) {
                loading.style.display = 'none';
                showError(`Error de conexi√≥n: ${error.message}`);
                console.error('Error buscando mensajes:', error);
            }
        }

        // Funci√≥n para actualizar el proyecto de una conversaci√≥n
        async function updateConversationProject(selectElement) {
            const conversationId = selectElement.getAttribute('data-conversation-id');
            const newProjectId = selectElement.value;
            const oldProjectId = selectElement.getAttribute('data-old-value') || selectElement.value;
            
            try {
                const response = await fetch(`${API_BASE}/update_conversation_project.php`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        conversation_id: conversationId,
                        project_id: newProjectId
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Mostrar mensaje de √©xito
                    showSuccess(`Conversaci√≥n movida a ${selectElement.options[selectElement.selectedIndex].text}`);
                    // Actualizar el valor anterior para futuras comparaciones
                    selectElement.setAttribute('data-old-value', newProjectId);
                } else {
                    // Revertir el cambio si fall√≥
                    selectElement.value = oldProjectId;
                    showError(`Error al actualizar: ${result.error}`);
                }
                
            } catch (error) {
                // Revertir el cambio si fall√≥
                selectElement.value = oldProjectId;
                showError(`Error de conexi√≥n: ${error.message}`);
            }
        }

        // Mostrar mensajes en tabla
        function displayMessages(messages) {
            const container = document.getElementById('resultsContainer');
            
            if (messages.length === 0) {
                container.innerHTML = '<div class="error">No se encontraron mensajes con los filtros aplicados.</div>';
                return;
            }
            
            const table = document.createElement('table');
            table.className = 'messages-table';
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>Proyecto</th>
                        <th>Conversaci√≥n</th>
                        <th>Rol</th>
                        <th>Contenido</th>
                    </tr>
                </thead>
                <tbody>
                    ${messages.map(msg => `
                        <tr>
                            <td>
                                <select class="project-selector" data-conversation-id="${msg.conversationId}" data-old-value="${msg.projectId}" onchange="updateConversationProject(this)">
                                    <option value="1" ${msg.projectId == 1 ? 'selected' : ''}>MercadoSur</option>
                                    <option value="64" ${msg.projectId == 64 ? 'selected' : ''}>ChatGPT</option>
                                    <option value="67" ${msg.projectId == 67 ? 'selected' : ''}>Proyecto Principal</option>
                                </select>
                            </td>
                            <td>${msg.conversationTitle}</td>
                            <td><span class="role-badge role-${msg.messageRole}">${msg.messageRole}</span></td>
                            <td class="message-content" title="${escapeHtml(msg.messageContent)}">${escapeHtml(msg.messageContent)}</td>
                        </tr>
                    `).join('')}
                </tbody>
            `;
            
            container.appendChild(table);
        }

        // Actualizar paginaci√≥n
        function updatePagination() {
            const container = document.getElementById('paginationContainer');
            const totalPages = Math.ceil(totalMessages / messagesPerPage);
            
            if (totalPages <= 1) {
                container.style.display = 'none';
                return;
            }
            
            container.style.display = 'flex';
            container.innerHTML = `
                <button onclick="changePage(${currentPage - 1})" ${currentPage === 0 ? 'disabled' : ''}>
                    ‚Üê Anterior
                </button>
                <span class="current-page">P√°gina ${currentPage + 1} de ${totalPages}</span>
                <button onclick="changePage(${currentPage + 1})" ${currentPage >= totalPages - 1 ? 'disabled' : ''}>
                    Siguiente ‚Üí
                </button>
            `;
        }

        // Cambiar p√°gina
        function changePage(newPage) {
            const totalPages = Math.ceil(totalMessages / messagesPerPage);
            
            if (newPage >= 0 && newPage < totalPages) {
                currentPage = newPage;
                searchMessages();
            }
        }

        // Mostrar error
        function showError(message) {
            const container = document.getElementById('errorContainer');
            container.innerHTML = `<div class="error">${message}</div>`;
        }

        // Mostrar mensaje de √©xito
        function showSuccess(message) {
            const container = document.getElementById('errorContainer');
            container.innerHTML = `<div class="update-success">${message}</div>`;
            // Ocultar el mensaje despu√©s de 3 segundos
            setTimeout(() => {
                container.innerHTML = '';
            }, 3000);
        }

        // Formatear fecha
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('es-ES', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Escapar HTML
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Event listeners
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                currentPage = 0;
                searchMessages();
            }
        });

        document.getElementById('projectSelect').addEventListener('change', function() {
            loadStats();
            currentPage = 0;
            searchMessages();
        });

        document.getElementById('currentProjectFilter').addEventListener('change', function() {
            currentPage = 0;
            searchMessages();
        });

        document.getElementById('roleFilter').addEventListener('change', function() {
            currentPage = 0;
            searchMessages();
        });

        document.getElementById('conversationSearch').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                currentPage = 0;
                searchMessages();
            }
        });
    </script>
</body>
</html>