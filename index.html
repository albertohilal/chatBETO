<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buscar Mensajes en Chat</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
            text-align: center;
        }
        table {
            width: 90%;
            margin: auto;
            border-collapse: collapse;
            background-color: white;
        }
        th, td {
            border: 1px solid black;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: blue;
            color: white;
        }
        .user { background-color: #d9ebff; }
        .assistant { background-color: #fff3c4; }
        img {
            max-width: 300px;
            height: auto;
            display: block;
        }
    </style>
</head>
<body>

    <h1>Buscar Mensajes en Chat</h1>
    <input type="text" id="query" placeholder="Buscar...">
    <button onclick="buscarMensajes()">Buscar</button>

    <table>
        <thead>
            <tr>
                <th>TÃ­tulo</th>
                <th>Fecha</th>
                <th>Rol</th>
                <th>Mensaje</th>
            </tr>
        </thead>
        <tbody id="resultados"></tbody>
    </table>

    <script>
        function buscarMensajes() {
            const query = document.getElementById("query").value;
            fetch(`buscar_chat.php?query=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    const resultados = document.getElementById("resultados");
                    resultados.innerHTML = "";

                    data.forEach(mensaje => {
                        const fila = document.createElement("tr");
                        fila.classList.add(mensaje.message_role === "user" ? "user" : "assistant");

                        const celdaTitulo = document.createElement("td");
                        celdaTitulo.textContent = mensaje.title;
                        
                        const celdaFecha = document.createElement("td");
                        const fecha = new Date(mensaje.create_time * 1000);
                        celdaFecha.textContent = fecha.toLocaleDateString() + ", " + fecha.toLocaleTimeString();

                        const celdaRol = document.createElement("td");
                        celdaRol.textContent = mensaje.message_role;

                        const celdaMensaje = document.createElement("td");

                        try {
                            const contenido = JSON.parse(mensaje.message_content);
                            if (contenido.content_type === "image_asset_pointer") {
                                const fileID = contenido.asset_pointer.replace("file-service://", "");
                                const posiblesExtensiones = ["png", "jpg", "jpeg", "gif", "webp"];
                                let imagenEncontrada = false;

                                posiblesExtensiones.forEach(ext => {
                                    const imageUrl = `uploads/${fileID}-image.${ext}`;
                                    fetch(imageUrl, { method: "HEAD" }) 
                                        .then(res => {
                                            if (res.ok && !imagenEncontrada) {
                                                celdaMensaje.innerHTML = `<img src="${imageUrl}" alt="Imagen">`;
                                                imagenEncontrada = true;
                                            }
                                        })
                                        .catch(() => {});
                                });

                                // Si no se encuentra la imagen, mostrar imagen por defecto
                                setTimeout(() => {
                                    if (!imagenEncontrada) {
                                        celdaMensaje.innerHTML = `<img src="uploads/imagen_no_disponible.png" alt="Imagen no encontrada">`;
                                    }
                                }, 500);

                            } else {
                                celdaMensaje.textContent = mensaje.message_content;
                            }
                        } catch (e) {
                            celdaMensaje.textContent = mensaje.message_content;
                        }

                        fila.appendChild(celdaTitulo);
                        fila.appendChild(celdaFecha);
                        fila.appendChild(celdaRol);
                        fila.appendChild(celdaMensaje);
                        resultados.appendChild(fila);
                    });
                })
                .catch(error => console.error("Error:", error));
        }
    </script>

</body>
</html>
